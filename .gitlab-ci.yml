stages:
  - build-base
  - build-extended
  - build-production

variables:
  DOCKER_REGISTRY: docker.io
  DOCKER_NAMESPACE: tavib47
  PHP_VERSIONS: "8.1 8.2 8.3 8.4 8.5"

# Use Docker-in-Docker
.docker-base:
  image: docker:27
  services:
    - docker:27-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin

# =============================================================================
# PHP-CI - Builds when php-ci/ changes (manual trigger)
# =============================================================================

php-ci:
  extends: .docker-base
  stage: build-base
  script:
    - |
      for version in ${PHP_VERSIONS}; do
        echo "Building php-ci:${version}"
        docker build --build-arg PHP_VERSION=${version} -t ${DOCKER_NAMESPACE}/php-ci:${version} ./php-ci
        docker push ${DOCKER_NAMESPACE}/php-ci:${version}
      done
    - LATEST_VERSION=$(echo ${PHP_VERSIONS} | tr ' ' '\n' | sort -V | tail -1)
    - docker tag ${DOCKER_NAMESPACE}/php-ci:${LATEST_VERSION} ${DOCKER_NAMESPACE}/php-ci:latest
    - docker push ${DOCKER_NAMESPACE}/php-ci:latest
  rules:
    # Manual trigger from web UI - always available
    - if: $CI_PIPELINE_SOURCE == "web"
      when: manual
    # Manual trigger on default branch when php-ci/ changes
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - php-ci/**/*
      when: manual

# =============================================================================
# DRUPAL-CI - Builds when php-ci/ or drupal-ci/ changes (manual trigger)
# =============================================================================

drupal-ci:
  extends: .docker-base
  stage: build-extended
  script:
    - |
      for version in ${PHP_VERSIONS}; do
        echo "Building drupal-ci:${version}"
        docker build --build-arg PHP_VERSION=${version} -t ${DOCKER_NAMESPACE}/drupal-ci:${version} ./drupal-ci
        docker push ${DOCKER_NAMESPACE}/drupal-ci:${version}
      done
    - LATEST_VERSION=$(echo ${PHP_VERSIONS} | tr ' ' '\n' | sort -V | tail -1)
    - docker tag ${DOCKER_NAMESPACE}/drupal-ci:${LATEST_VERSION} ${DOCKER_NAMESPACE}/drupal-ci:latest
    - docker push ${DOCKER_NAMESPACE}/drupal-ci:latest
  needs:
    - job: php-ci
      optional: true
  rules:
    # Manual trigger from web UI - always available
    - if: $CI_PIPELINE_SOURCE == "web"
      when: manual
    # Manual trigger on default branch when php-ci/ changes (base image updated)
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - php-ci/**/*
      when: manual
    # Manual trigger on default branch when drupal-ci/ changes
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - drupal-ci/**/*
      when: manual

# =============================================================================
# PHP-FPM - Production PHP-FPM image (manual trigger)
# =============================================================================

php-fpm:
  extends: .docker-base
  stage: build-production
  script:
    - |
      for version in ${PHP_VERSIONS}; do
        echo "Building php-fpm:${version}"
        docker build --build-arg PHP_VERSION=${version} -t ${DOCKER_NAMESPACE}/php-fpm:${version} ./php-fpm
        docker push ${DOCKER_NAMESPACE}/php-fpm:${version}
      done
    - LATEST_VERSION=$(echo ${PHP_VERSIONS} | tr ' ' '\n' | sort -V | tail -1)
    - docker tag ${DOCKER_NAMESPACE}/php-fpm:${LATEST_VERSION} ${DOCKER_NAMESPACE}/php-fpm:latest
    - docker push ${DOCKER_NAMESPACE}/php-fpm:latest
  rules:
    # Manual trigger from web UI - always available
    - if: $CI_PIPELINE_SOURCE == "web"
      when: manual
    # Manual trigger on default branch when php-fpm/ changes
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - php-fpm/**/*
      when: manual
